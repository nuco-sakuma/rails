# rails

# 初回構築手順書
## 方針
* dockerを利用して初回構築を実施

​

​
​
## 初回構築時の利用ファイル
1. rails/docker-compose.yml
```
version: "3"
services:
  web_app:
    build:
      context: .
      dockerfile: web_app/docker/rails/Dockerfile
    volumes:
      - ./web_app:/web_app
```

2. rails/web_app/docker/rails/Dockerfile
```
FROM ruby:3.1.0-slim

ENV APP_ROOT /web_app

RUN mkdir -p $APP_ROOT

COPY $APP_ROOT $APP_ROOT/

WORKDIR $APP_ROOT
```
​
3. rails/web_app/docker/mysql/Dockerfile
```
FROM mysql:8.0
​
ADD ./web_app/docker/mysql/my.cnf /etc/mysql/conf.d/my.cnf
```
​
4. rails/web_app/docker/mysql/my.cnf
```
[mysqld]
default-authentication-plugin=mysql_native_password
```
​
## 手順
### 1. dockerイメージを作成し、コンテナ内に入る
```
# host
docker-compose build
docker-compose run web_app sh
```
​
### 2. コンテナ内で必要なものをインストールし、初期ファイルを取得
```
# in container
apt-get update
apt-get install -y git build-essential default-libmysqlclient-dev
gem i -v 7.0 rails
rails new . -d mysql
```
* git: .gitignore作成用
* default-libmysqlclient-dev: mysql2のエラー回避用
* 取得した.gitignore
```
# See https://help.github.com/articles/ignoring-files for more about ignoring files.
#
# If you find yourself ignoring temporary files generated by your text editor
# or operating system, you probably want to add a global ignore instead:
#   git config --global core.excludesfile '~/.gitignore_global'
​
# Ignore bundler config.
/.bundle
​
# Ignore all logfiles and tempfiles.
/log/*
/tmp/*
!/log/.keep
!/tmp/.keep
​
# Ignore pidfiles, but keep the directory.
/tmp/pids/*
!/tmp/pids/
!/tmp/pids/.keep
​
# Ignore uploaded files in development.
/storage/*
!/storage/.keep
/tmp/storage/*
!/tmp/storage/
!/tmp/storage/.keep
​
# Ignore master key for decrypting credentials and more.
/config/master.key
​
```
* 取得した.gitattributes
```
# See https://git-scm.com/docs/gitattributes for more about git attribute files.
​
# Mark the database schema as having been generated.
db/schema.rb linguist-generated
​
# Mark any vendored files as having been vendored.
vendor/* linguist-vendored
​
```
### 3. 不要ファイル、ディレクトリを削除し、再度railsコマンド実施
```
find . -maxdepth 1 ! -name '.' ! -name 'docker' ! -name '.gitattributes' ! -name '.gitignore' -exec rm -rf {} \;
​
rails new . -d mysql
```
### 4. 下記ファイル内容を更新
* rails/docker-compose.yml
```
version: "3"
services:
  web_app:
    build:
      context: .
      dockerfile: web_app/docker/rails/Dockerfile
    volumes:
      - ./web_app:/web_app
    command: rails s -b 0.0.0.0 -p 3000
    ports:
      - 3001:3000
    depends_on:
      - web_app-mysql
  web_app-mysql:
    build:
      context: .
      dockerfile: web_app/docker/mysql/Dockerfile
    environment:
      MYSQL_ROOT_PASSWORD: test
    ports:
      - 3306:3306
    volumes:
      - db-store-web_app:/var/lib/mysql
    platform: linux/amd64
volumes:
  db-store-web_app:
```
​
* rails/web_app/docker/rails/Dockerfile
```
FROM ruby:3.1.0-slim
​
ENV APP_ROOT /web_app
RUN mkdir -p $APP_ROOT
​
COPY $APP_ROOT $APP_ROOT/
​
WORKDIR $APP_ROOT
​
ADD ./web_app/Gemfile $APP_ROOT/Gemfile
ADD ./web_app/Gemfile.lock $APP_ROOT/Gemfile.lock
​
​
ENV RUNTIME_PACKAGES="\
      default-libmysqlclient-dev\
      build-essential\
    " \
    LANG=C.UTF-8 \
    TZ=Asia/Tokyo
RUN apt-get update && apt-get install -y ${RUNTIME_PACKAGES}
​
RUN bundle install --jobs=4
```
​
* rails/web_app/config/database.ymlのdefault: &defaultブロックに追加する（docker-compose.ymlの内容に合わせる）
```
password: test
host: web_app-mysql
```
​
### 5. DB作成
```
# host
docker-compose build
docker-compose run web_app sh

# in container
rails db:create
bin/rails db:migrate RAILS_ENV=development
```
​
### 6. 接続確認
```
docker-compose up
```
* localhost:3001にアクセス
<!-- 
### 7. Userリソース作成
```
docker compose run web_app sh
rails generate scaffold User name:string email:string
rails db:migrate
```
URL	          | アクション |用途
/users	      |index	    |すべてのユーザーを一覧するページ
/users/1	    |show	      |id=1のユーザーを表示するページ
/users/new    |	new	      |新規ユーザーを作成するページ
/users/1/edit |	edit	    |id=1のユーザーを編集するページ

### 8. マイクロポスト作成
```
docker compose run web_app sh
rails generate scaffold Micropost content:text user_id:integer
rails db:migrate
```

### 8. 静的なページ作成
```
docker compose run web_app sh
rails generate controller StaticPages home help -->



## データベースの確認方法
```
docker-compose exec web_app-mysql bash
mysql -u root -p
PW -> test

# コマンド
show databases;
use web_app_development;
show tables; #テーブルの確認
desc user; #テーブル設計の確認
select * from users;
```


## python実行
```
docker-compose run python_app sh
# nba-api/sample.pyを実行する場合
python nba-api/sample.py
```

dropdown
# やったコマンド
## モデルの追加(branch: dropdown)
```
rails generate controller dropdown
rails generate model nba_players id:integer player_name:string
```

## モデルの要素追加(ブランチ: mysql)
(例)
rails generate migration add_password_digest_to_users password_digest:string

```
rails generate migration add_sum_score_to_nba_players sum_score:integer
rails generate migration add_post_count_to_nba_players post_count:integer
rails generate migration add_score_to_nba_players score:integer

```
## プレイヤー表示画面
```
rails generate controller NbaPlayer
rails destroy controller NbaPlayer
rails generate controller NbaPlayers new

```

## nba_playerブランチ
```
rails destroy model nba_players id:integer player_name:string
rails destroy migration add_sum_score_to_nba_players sum_score:integer
rails destroy migration add_post_count_to_nba_players post_count:integer
rails destroy migration add_score_to_nba_players score:integer 

rails generate model nba_player player_name:string sum_score:integer post_count:integer score:integer 

rails destory model nba_player player_name:string sum_score:integer post_count:integer score:integer 

rails destroy model nba_players player_name:string


rails destroy model review user: references nba_player:references content:string score:integer
rails destroy controller reviews index
    <%= f.select :sum_score, options_for_select((1..100).to_a), {}, { class: 'form-control' } %>
```